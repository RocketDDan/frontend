pipeline {
    agent any

    tools {
        nodejs 'NodeJS 16.13.2'
    }

    environment {
        // Docker Hub ë¡œê·¸ì¸ ì •ë³´ (Jenkins Credential ID)
        IMAGE_NAME        = 'hanol98/runners-hi-frontend'
        K8S_MANIFEST_DIR  = 'deploy/k8s'
        GIT_CONFIG_USERNAME = 'hanol98'
        GIT_CONFIG_EMAIL = 'hanol98@naver.com'
    }

    options {
        // workspaceë¥¼ ê¹¨ë—í•˜ê²Œ ìœ ì§€í•˜ë˜, ìºì‹œëŠ” ë³„ë„ë¡œ ê´€ë¦¬
        skipDefaultCheckout(false)
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Install Dependencies') {
            steps {
                sh '''
                    echo "ğŸ“¦ Installing dependencies"
                    npm install
                '''
            }
        }

        stage('Build React') {
            steps {
                sh '''
                    echo "ğŸ”¨ Building React App"
                    CI=false GENERATE_SOURCEMAP=false npm run build
                '''
            }
        }

        stage('Build & Push Docker Image') {
            steps {
                script {
                    // 1) Docker ë¹Œë“œ
                    sh """
                        echo "ğŸ³ Building Docker image"
                        docker build -t ${IMAGE_NAME}:${BUILD_NUMBER} .
                    """
                    // 2) Docker Hub ë¡œê·¸ì¸ & í‘¸ì‹œ
                    withCredentials([
                        usernamePassword(
                            credentialsId: 'Docker-Hub-Access-Token',
                            usernameVariable: 'DOCKER_USER',
                            passwordVariable: 'DOCKER_PASS'
                        )
                    ]) {
                        sh """
                            echo "ğŸ”‘ Docker login"
                            echo "${DOCKER_PASS}" | docker login -u "${DOCKER_USER}" --password-stdin
                            echo "ğŸš€ Pushing image"
                            docker push ${IMAGE_NAME}:${BUILD_NUMBER}
                        """
                    }
                }
            }
        }
    }

    post {
        always {
            echo 'ğŸ§¹ Cleaning workspace'
            sh '''
                rm -rf build
            '''
        }
    }
}
