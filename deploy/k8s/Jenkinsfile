pipeline {
    agent any

    tools {
        nodejs 'NodeJS 16.13.2'
    }

    environment {
        // Docker Hub ë¡œê·¸ì¸ ì •ë³´ (Jenkins Credential ID)
        IMAGE_NAME        = 'hanol98/runners-hi-frontend'
        K8S_MANIFEST_DIR  = 'deploy/k8s'
        GIT_CONFIG_USERNAME = 'hanol98'
        GIT_CONFIG_EMAIL = 'hanol98@naver.com'
    }

    options {
        // workspaceë¥¼ ê¹¨ë—í•˜ê²Œ ìœ ì§€í•˜ë˜, ìºì‹œëŠ” ë³„ë„ë¡œ ê´€ë¦¬
        skipDefaultCheckout(false)
    }

    stages {
        stage('Skip Check') {
            when {
                expression {
                    // ë§ˆì§€ë§‰ ì»¤ë°‹ ë©”ì‹œì§€ë¥¼ ì½ì–´ì„œ [ci skip] í¬í•¨ ì‹œ ì „ì²´ íŒŒì´í”„ë¼ì¸ ì¢…ë£Œ
                    return sh(
                        script: 'git log -1 --pretty=%B', 
                        returnStdout: true
                    ).trim().contains('[ci skip]')
                }
            }
            steps {
                echo "ğŸ“Œ Detected [ci skip], skipping entire build."
                // ì—ëŸ¬ ì—†ì´ ì¢…ë£Œ
                script { currentBuild.result = 'SUCCESS'; error('Skipping build') }
            }
        }

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Install Dependencies') {
            steps {
                sh '''
                    echo "ğŸ“¦ Installing dependencies"
                    npm install
                '''
            }
        }

        stage('Build React') {
            steps {
                sh '''
                    echo "ğŸ”¨ Building React App"
                    CI=false GENERATE_SOURCEMAP=false npm run build
                '''
            }
        }

        stage('Build & Push Docker Image') {
            steps {
                script {
                    // 1) Docker ë¹Œë“œ
                    sh """
                        echo "ğŸ³ Building Docker image"
                        docker build -t ${IMAGE_NAME}:${BUILD_NUMBER} .
                    """
                    // 2) Docker Hub ë¡œê·¸ì¸ & í‘¸ì‹œ
                    withCredentials([
                        usernamePassword(
                            credentialsId: 'Docker-Hub-Access-Token',
                            usernameVariable: 'DOCKER_USER',
                            passwordVariable: 'DOCKER_PASS'
                        )
                    ]) {
                        sh """
                            echo "ğŸ”‘ Docker login"
                            echo "${DOCKER_PASS}" | docker login -u "${DOCKER_USER}" --password-stdin
                            echo "ğŸš€ Pushing image"
                            docker push ${IMAGE_NAME}:${BUILD_NUMBER}
                        """
                    }
                }
            }
        }

        stage('GitOps: Update K8s Manifest') {
            steps {
                script {
                    // Git ì‚¬ìš©ì ì •ë³´ ì„¤ì •
                    sh """
                        git config user.name "${GIT_CONFIG_USERNAME}"
                        git config user.email "${GIT_CONFIG_EMAIL}"
                    """
                    // deployment YAMLì˜ image íƒœê·¸ ì—…ë°ì´íŠ¸
                    sh """
                        echo "âœï¸ Bumping K8s manifest image tag"
                        sed -i \\
                        -e "s|image: ${IMAGE_NAME}:.*|image: ${IMAGE_NAME}:${BUILD_NUMBER}|g" \\
                        ${K8S_MANIFEST_DIR}/deployment-frontend.yaml
                    """
                    // ì»¤ë°‹ & í‘¸ì‹œ
                    withCredentials([
                        usernamePassword(
                            credentialsId: 'Git-Hub-Access-Token',
                            usernameVariable: 'GIT_USER',
                            passwordVariable: 'GIT_PASS')
                    ]) {
                        sh """
                            git add ${K8S_MANIFEST_DIR}/deployment-frontend.yaml
                            git commit -m "ci: bump frontend image to ${BUILD_NUMBER} [ci skip]"
                            git push https://${GIT_USER}:${GIT_PASS}@github.com/RocketDDan/frontend.git HEAD:main
                        """
                    }
                }
            }
        }

        // (ì„ íƒ) ë°”ë¡œ Argo CD sync ë¥¼ íŠ¸ë¦¬ê±° í•˜ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ìŠ¤í…Œì´ì§€ ì¶”ê°€
        // stage('ArgoCD Sync') {
        //     steps {
        //         withCredentials([
        //             string(credentialsId: 'argocd-server', variable: 'ARGO_SERVER'),
        //             string(credentialsId: 'argocd-token',  variable: 'ARGO_TOKEN')
        //         ]) {
        //             sh """
        //                 # 1) ë™ê¸°í™” ì‹¤í–‰
        //                 argocd --grpc-web --insecure \
        //                     --server ${ARGO_SERVER} \
        //                     --auth-token ${ARGO_TOKEN} \
        //                     app sync runners-hi-frontend

        //                 # 2) (ì„ íƒ) ë™ê¸°í™”ê°€ ëë‚  ë•Œê¹Œì§€ ëŒ€ê¸°
        //                 argocd --grpc-web --insecure \
        //                     --server ${ARGO_SERVER} \
        //                     --auth-token ${ARGO_TOKEN} \
        //                     app wait runners-hi-frontend --health --timeout 300
        //             """
        //         }
        //     }
        // }
    }

    post {
        always {
            echo 'ğŸ§¹ Cleaning workspace'
            sh '''
                rm -rf build
            '''
        }
    }
}
